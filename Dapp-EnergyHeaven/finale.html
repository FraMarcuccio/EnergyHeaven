<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!--Font bello per le icone-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  
  <link rel="stylesheet" href="finale.css">


  <!--Si può cambiare con il file BS locale-->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

  <title>Speriamo funzioni mannaggia i morti</title>
</head>

<!--onload="sellingGraph()"-->
<body>

  <div class="navbar">
    <a href="#home">Home</a>
    <div class="subnav">
      <button class="subnavbtn">Utente
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="subnavcnt">
        <a href="#login">Login</a>
        <a href="#logout">Logout</a>
      </div>
    </div>
  </div>


  <div class="obtaintks">
    <form class="obtaintks" onsubmit="obtain_tokens(), getUserBalance(); return false;">
      <p>obtain tokens</p>    
      <input type="number" id="input" required="required">
      <button type="submit">obtain_tokens</button>
      </form>
  </div>

  <div class="become_prod">
    <form class="become_prod" onsubmit="join_as_producer(), getUserBalance(); return false;">
      <p>become producer</p>    
      <input type="checkbox" id="producer" required="required" value="yes"> 
      <button type="submit">become</button>
      </form>
  </div>


  <div class="ETH">
    <!--Da finire, solo scheletro HTML-->
    <form class="eth" onsubmit="tokens_to_ETH(), getUserBalance(); return false;">
      <p>obtain ETH</p>    
      <input type="number" id="input2" required="required">
      <button type="submit">tokens_to_ETH</button>
    </form>
  </div>

  <div class="a">
    <form class="a" onsubmit="buy_energy(), getUserBalance(); return false;">
      <p>buy energy</p>    
      <input type="number" id="input3" required="required">
      <button type="submit">BUY!</button>
    </form>
    <p>show graph for buying energy options</p>    
    <!--<button onclick="buy_energy()">buy_energy</button> --> 
  </div>

  <div class="b">
    <form class="b" onsubmit="sell_energy(); return false;">
      <p>SELL energy</p>    
      <input type="number" id="input4" required="required">
      <input type="number" id="input5" required="required">
      <button type="submit">SELL!</button>
    </form>
    <p>show graph for selling energy options</p>     
    <!--<button onclick="sell_energy()">sell_energy</button> --> 
  </div>

  <div class="c">
    <p></p>
    <button class="openbtn" onclick="openSelling()">Selling graph and options</button>
  
  </div>
  

  <div class="e">
    <p></p>
    <button onclick="openBuying()" class="drop">Buying graph and buying options</button>
  
  </div>
  
  <script>

    function getUserBalance(){
      contract.methods.userBalance(senderAddress).call({from:senderAddress, gas: 120000}).then(function(result) { // A promise in action
      $("#balance").html(result);
    }).catch((error) => { console.error(error); });
    }

  </script>


  <!--graph canvas-->


  <div class="grid">
    <div class="col50">
    </div>

  </div>


  <div class="maingrid">
    <div class="bu">balance+user</div>
    <div class="b">buttom</div>
    <div class="g">graphs
      <div class="col50">
        <canvas class="selling" id="selling"></canvas>
      </div>
    </div>
  </div>




  <!--Popup sellings options-->
  <div class="popupselling" id="popupSelling">
    <form class="container">
      <h2>Selling options</h2>

      <label for="energy">Quantity of energy</label>
      <input type="number" required>

      <label for="price">Price of energy</label>
      <input type="number" required>

      <button type="submit" class="sell">Sell energy</button>
      <button type="button" class="cancel" onclick="closeSelling()">Close</button>
    </form>
  </div>
  

  <!--popup buying options-->
  <div id="popupBuying">
    <form onmouseout="buy_energy()">
      <a href="#">prova1</a>
      <a href="#">prova2</a>
      <a href="#">prova3</a>
    </form>
  </div>


  <div id="popup2">
    <form onclick="buy_energy()"></form>
    <input type="radio" id="list1" value="mettere valore">
    <label for="list1">list1</label>

    <input type="radio" id="list2" value="mettere valore">
    <label for="list2">list2</label>

    <input type="radio" id="list3" value="mettere valore">
    <label for="list3">list3</label>
  </div>





  <label id="label">provaprovarpovaas</label>

  <label id="balance">asasdasd</label>

  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/web3.min.js"></script>

  <!--Per i grafici, guardare come fare ad inserire nei valori X/Y i dati dal contratto-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
  <script>
    function sellingGraph(){
    var xValues = [50,60,70,80,90,100,110,120,130,140,150];
    var yValues = [7,8,8,9,9,9,10,11,14,14,15];
    
    new Chart("selling", {
      type: "line",
      data: {
        labels: xValues,
        datasets: [{
          fill: false,
          lineTension: 0,
          backgroundColor: "rgba(0,0,255,1.0)",
          borderColor: "rgba(0,0,255,0.1)",
          data: yValues
        }]
      },
      options: {
        legend: {display: false},
        scales: {
          yAxes: [{ticks: {min: 6, max:16}}],
        }
      }
    });
    }
  </script>

<script>
  window.onload = sellingGraph();
</script>
  <!--label per aggiornare bilanci degli account-->

  <script>
    document.getElementById("label").innerHTML = 'esce questa scritta quando carica tutta la pagina';
    

    //aggiorna continuamente il valore mentre la pagina è aperta, da provare non sono convintissimo funzioni correttamente
    function addLoadEvent(func){
      var oldload =window.onload;
      if(typeof window.onload != 'function'){
        window.onload = func;
      }
      else{
        window.onload = func;
        if(oldload){
          oldload();
        }
        func();
      }
    }

    addLoadEvent(function(){ 
      document.getElementById("label").innerHTML = 'ciaocaicoascafas';
      getUserBalance();
    });
  
  </script>

  <!--popup sellings-->
  <script>

  function openSelling(){
    document.getElementById("popupSelling").style.display = "block";
  }

  function closeSelling(){
    document.getElementById("popupSelling").style.display = "none";
  }

  </script>


  <!--popup buying options-->
  <script>
    function openBuying(){
      document.getElementById("popup2").classList.toggle("show");
    }

    //chiude menu popup quando clicchi fuori dal menu
    window.onclick = function(event){
      if(!event.target.matches('.drop')){
        var dropdowns = document.getElementById("popupBuying");
        var i;
        for(i = 0; i < dropdowns.length; i++){
          var openDD = dropdowns[i];
          if(openDD.classList.contains('show')){
            openDD.classList.remove('show');
          }
        }
      }
    }

  </script>


  <script>

  // Initialisation of Web3
  if (typeof web3 !== 'undefined') {
    web3 = new Web3(web3.currentProvider);
  } else {
    web3 = new Web3(new Web3.providers.WebsocketProvider("ws://localhost:7545"));
  }

  

  // Set contract ABI
  var contractAbi = [
    {
      "inputs": [],
      "stateMutability": "nonpayable",
      "type": "constructor"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "address",
          "name": "user",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "tokens",
          "type": "uint256"
        }
      ],
      "name": "AcquiringTokens",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "address",
          "name": "user",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "tokens",
          "type": "uint256"
        }
      ],
      "name": "TokensToEth",
      "type": "event"
    },
    {
      "inputs": [],
      "name": "JOIN_AMOUNT",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "PRICE",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "REVERSE_EXC_VALUE",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "name": "energyList",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "price",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "minter",
      "outputs": [
        {
          "internalType": "address payable",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "piggyBank",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "name": "userBalance",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "join_as_producer",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "obtain_tokens",
      "outputs": [],
      "stateMutability": "payable",
      "type": "function",
      "payable": true
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        }
      ],
      "name": "tokens_to_ETH",
      "outputs": [],
      "stateMutability": "payable",
      "type": "function",
      "payable": true
    },
    {
      "inputs": [],
      "name": "self_distruct",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "price",
          "type": "uint256"
        }
      ],
      "name": "sell_energy",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "tokens",
          "type": "uint256"
        }
      ],
      "name": "buy_energy",
      "outputs": [
        {
          "internalType": "bool",
          "name": "result",
          "type": "bool"
        },
        {
          "internalType": "uint256",
          "name": "bought_amount",
          "type": "uint256"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "function"
    }
  ]


  // Set the contract address
  var contractAddress = '0x2264abE36DE264646C96f00f0c632DAaBf493bc6';
  // Insert your contract address there

  // Set the address from which transactions are sent
  var senderAddress = '0xAD5a29f9bB5CfAC473Fd77856828961a761b6Afa';
  // Insert your contract address there

  // Set the contract
  var contract = new web3.eth.Contract(contractAbi, contractAddress);


  function obtain_tokens(){
    var input =$('#input').val() * 10 **15;

    if (input < 1) {
      alert("The numb should be higher than 0");
      return false;
    }

    console.log("input number is " + input);

    contract.methods.obtain_tokens().call({from:senderAddress, value:input}).then(function(result) {
      console.log("number in input: " + input);
    });

    contract.methods.obtain_tokens().send({from:senderAddress, value:input}).on('receipt',function(receipt){
      console.log("Tx Hash: " + receipt.transactionHash);
    });

    return false;
  }

  function tokens_to_ETH(){
    var input =$('#input2').val();

    if (input < 1) {
      alert("The numb should be higher than 0");
      return false;
    }

    console.log("input number is " + input);

    contract.methods.tokens_to_ETH(input).call({from:senderAddress, gas:120000}).then(function(result) {
      console.log("number in input: " + input);
    });

    contract.methods.tokens_to_ETH(input).send({from:senderAddress, gas:120000}).on('receipt',function(receipt){
      console.log("Tx Hash: " + receipt.transactionHash);
    });

    return false;
  }

  function join_as_producer(){
    var input =$('#producer').val();


    if (input == "yes" ) {
      console.log("input number is " + input);


      contract.methods.join_as_producer().call({from:senderAddress, gas:120000}).then(function(result) {
        console.log("input: " + input);
      });

      contract.methods.join_as_producer().send({from:senderAddress, gas:120000}).on('receipt',function(receipt){
        console.log("Tx Hash: " + receipt.transactionHash);
      });

    }


   
    return false;
  }

  function buy_energy(){
    var input =$('#input3').val();


    if (input < 1) {
      alert("The numb should be higher than 0");
      return false;
    }


    console.log("input number is " + input);


    contract.methods.buy_energy(input).call({from:senderAddress, gas:120000}).then(function(result) {
      console.log("number in input: " + input);
    });

    contract.methods.buy_energy(input).send({from:senderAddress, gas:120000}).on('receipt',function(receipt){
      console.log("Tx Hash: " + receipt.transactionHash);
    });

    return false;
  }

  function sell_energy(){
    var amount =$('#input4').val();
    var price =$('#input5').val();


    if (amount < 1) {
      alert("The amount should be higher than 0");
      return false;
    }

    if (price < 1) {
      alert("The price should be higher than 0");
      return false;
    }


    console.log("amount is " + amount);
    console.log("price is " + price);


    contract.methods.sell_energy(amount,price).call({from:senderAddress, gas:120000}).then(function(result) {
      console.log("amount in input " + amount);
      console.log("price in input " + price);
    });

    contract.methods.sell_energy(amount,price).send({from:senderAddress, gas:120000}).on('receipt',function(receipt){
      console.log("Tx Hash: " + receipt.transactionHash);
    });

    return false;
  }
  
  </script>





</body>
</html>