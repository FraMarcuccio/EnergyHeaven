<!DOCTYPE html>
<html lang="en">
  <meta charset="utf-8">
  <head>
    <title>BitMathGame</title>
    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
    <main class="container">
      <section id="playingthegame">
        <form onsubmit="play(); return false;" id="playform">
          <fieldset>
            <legend>Try and win</legend>
            <label for="guessinput" />
            <!-- Notice the "required" attribute -->
            <input type="number" name="guess" id="guessinput"
                required="required"/>
            <button type="submit">Check!</button>
          </fieldset>
        </form>
      </section>
    </main>
  </body>
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/web3.min.js"></script>
  <script>
    // Prevent forms from submitting and reloading the page
    $("form").submit(function(e){e.preventDefault();});

    // Initialisation of Web3
    if (typeof web3 !== 'undefined') {
      web3 = new Web3(web3.currentProvider);
    } else {
      // Set the provider you want from Web3.providers
      // Use the WebSocketProvider to enable events subscription.
      web3 = new Web3(new Web3.providers.WebsocketProvider(
               "ws://localhost:7545"));
    }


    // Set contract ABI
    var contractAbi = [
    {
      "inputs": [],
      "stateMutability": "nonpayable",
      "type": "constructor"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "address",
          "name": "buyer",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "tokens",
          "type": "uint256"
        }
      ],
      "name": "Acquiring",
      "type": "event"
    },
    {
      "inputs": [],
      "name": "JOIN_AMOUNT",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "PRICE",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "REVERSE_EXC_VALUE",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "name": "energyList",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "price",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "minter",
      "outputs": [
        {
          "internalType": "address payable",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "piggyBank",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "name": "userBalance",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "join_as_producer",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "obtain_tokens",
      "outputs": [],
      "stateMutability": "payable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        }
      ],
      "name": "tokens_to_ETH",
      "outputs": [],
      "stateMutability": "payable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "self_distruct",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "price",
          "type": "uint256"
        }
      ],
      "name": "sell_energy",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "tokens",
          "type": "uint256"
        }
      ],
      "name": "buy_energy",
      "outputs": [
        {
          "internalType": "bool",
          "name": "result",
          "type": "bool"
        },
        {
          "internalType": "uint256",
          "name": "bought_amount",
          "type": "uint256"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "function"
    }
    ]
    // Insert your contract ABI there

    // Set the contract address
    var contractAddress = '0x3F033807F6714E138fBb5b47cEebb607F8D9CA60';
    // Insert your contract address there

    // Set the address from which transactions are sent
    var senderAddress = '0x77f1E9e68d09E8d98130c7794aacE4Ed68083e30';
    // Insert your contract address there

    // Set the contract
    var contract = new web3.eth.Contract(contractAbi, contractAddress);

    // Subscribe to all events emitted by the contract
    contract.events.allEvents(
      function(error, event){ // A "function object". Explained here: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions#The_function_expression_(function_expression)
        if (error) {
          // Useful one: it made me understand that WebSocketProvider was needed
          console.log(error);
        } else {
          console.log(event);
        }
    });

    // Function to be called to play
    function play() {
      var givenGuess = $('#guessinput').val();
      // Check that the value is a positive integer
      if (givenGuess < 1) {
        alert("The given guess should be higher than 0");
        return false;
      }
      // Add the log entry on the console
      console.log("Provided guess is: " + givenGuess);
      // A promise in action
      
      /* Notice that call(…) has no side effect on the real contract,
         whereas send(…) does have a side-effect on the contract state */
      contract.methods.obtain_tokens().send({from:senderAddress}).on('receipt',
          function(receipt){
              console.log("Tx Hash: " + receipt.transactionHash);
      });

      return false;
    }
  </script>
</html>
